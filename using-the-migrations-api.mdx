---
title: "Using the Migrations API"
description: "How to use the Migrations API to migrate your users"
---

The Migrations API is a powerful tool for migrating users to Clerk, especially when performing an expand and contract database migration.

## Prerequisites

- A Clerk account
- A Clerk API key
- Good understanding of expand and contract data migrations (see [this article](https://www.prisma.io/dataguide/types/relational/expand-and-contract-pattern) for more information)

## Understanding the Migrations API

The Migrations API allows you to interact with Clerk's API without knowing a given user's Clerk user ID. Instead, you use an `external_id_mapped_as_user_id` wherever you would normally use a `user_id` in both body parameters and path parameters.

Here's an example of how to use the Migrations API to update a user's email address:

```typescript
const axios = require("axios");

// Example function to update a user's email address
async function updateUserEmail(externalId, newEmail) {
  try {
    const response = await axios({
      method: "PATCH",
      url: `https://api.clerk.com/v1/migrations/users/${externalId}`,
      headers: {
        Authorization: `Bearer ${process.env.CLERK_API_KEY}`,
        "Content-Type": "application/json",
      },
      data: {
        email_address: newEmail,
      },
    });

    console.log("Update request enqueued:", response.data);
    return response.data;
  } catch (error) {
    console.error(
      "Error updating user email:",
      error.response ? error.response.data : error.message
    );
    throw error;
  }
}
```

This is particularly useful during expand and contract migrations because during the contract phase, you're still reading from the old auth IDs and don't yet have Clerk user IDs.

<Tip>
  The `external_id_mapped_as_user_id` acts as a bridge between your existing
  system and Clerk, allowing for a smooth transition.
</Tip>

### Supported Routes:

- `POST /migrations/users`
- `PATCH /migrations/users/{external_id_mapped_as_user_id}`
- `DELETE /migrations/users/{external_id_mapped_as_user_id}/ban`
- `POST /migrations/users/{external_id_mapped_as_user_id}/unban`
- `POST /migrations/users/{external_id_mapped_as_user_id}/lock`
- `POST /migrations/users/{external_id_mapped_as_user_id}/unlock`
- `PATCH /migrations/users/{external_id_mapped_as_user_id}/metadata`
- `POST /migrations/users/{external_id_mapped_as_user_id}/verify_password`
- `POST /migrations/users/{external_id_mapped_as_user_id}/verify_totp`
- `DELETE /migrations/users/{external_id_mapped_as_user_id}/mfa`

All the routes follow the same schema as found in [Clerk's API Reference](https://clerk.com/docs/reference/backend-api). But remember that in all places where there is a `user_id` in the body or path, you should use `external_id_mapped_as_user_id`.

## Responses from the Migrations API

The Migrations API's use of `external_id_mapped_as_user_id` as the `user_id` means the Clerk API calls are not immediate and are instead enqueued. Instead, the process works as follows:

1. The request is enqueued for processing
2. Upon successful enqueuing, a 202 (Accepted) response is returned
3. In certain scenarios where immediate enqueuing isn't possible but the request can still be processed, a 200 (OK) response is returned

This asynchronous approach allows for efficient handling of large-scale migrations without overwhelming the system.

### Error Handling and Data Integrity

The Migrations API includes robust error handling mechanisms:

- If the API can process the error, the request will still succeed with a status 200 despite the error, preventing you from breaking your application.
- If an error occurs during processing, it's logged and can be reviewed in the dashboard
- The dashboard provides detailed information about any issues, allowing you to address them before finalizing the migration. Read the [Migrations API Dashboard](/using-the-migrations-api#monitoring-the-migrations-api) to learn more.

For example, if there's a schema mismatch or other configuration issue, the request won't result in an error response. Instead, the dashboard will flag the issue and prevent the migration from being completed until it's resolved.

<Warning>
  If the Migrations API returns anything other than a 202 or 200, it means the
  request was not processed and your data might be inconsistent. Make sure to
  implement your own logging or database transactions to ensure data integrity.
</Warning>

## Expectations of the Migrations API

For the Migrations API to function correctly, it must eventually map the `external_id_mapped_as_user_id` to a Clerk `user_id`. Importantly, this mapping doesn't need to occur immediately and can be done after user edits.

<Steps>
  <Step title="Edit User Data">
    Edit user data alongside your existing user management system.
  </Step>
  <Step title="Create The User ">
    Make a `POST` request to the `/migrations/users` endpoint during a trickle
    migration or batch import.
  </Step>
  <Step title="Linking">
    Once the user is created in clerk, all edits to that user will then be
    processed automatically in the correct order.
  </Step>
  <Step title="Finalize">
    Once all users have mapped user ids in the migration API and there are no
    errors, click the "Finish Migration" button in the dashboard.
  </Step>
</Steps>

## Monitoring the Migrations API with the Dashboard

Given that the Migrations API enqueues requests, immediate confirmation of successful Clerk API calls isn't possible. To address this, we've developed a comprehensive dashboard for monitoring and managing the Migrations API.

The dashboard offers:

- Live logs
- Real-time metrics
- A "Finish Migration" button

### Finish Migration Button

<Info>
  The "Finish Migration" button becomes active only when all necessary checks
  have passed, ensuring a safe and complete migration.
</Info>

This crucial feature finalizes the migration process. It's enabled only after successful verification of all checks, including confirmation that all `external_id_mapped_as_user_id` values are correctly mapped to Clerk user IDs.
